<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFTA Wizard - Fuel Tax Calculator</title>
    
    <!-- Security Headers (X-Frame-Options must be set via HTTP headers, not meta) -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://apis.google.com https://accounts.google.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://cdn.emailjs.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: https: blob:;
        connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebase.com https://*.firebaseapp.com https://api.emailjs.com https://firestore.googleapis.com https://www.gstatic.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://content.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com;
        frame-src 'self' https://accounts.google.com https://apis.google.com https://content.googleapis.com https://*.firebaseapp.com;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <!-- Google Identity Services & API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <!-- EmailJS for sending verification codes -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
    <!-- Auth Modal - starts hidden, shown only if not authenticated -->
    <div id="authModal" class="auth-modal hidden" style="display: none;" role="dialog" aria-modal="true" aria-labelledby="authTitle">
        <div class="auth-modal-content">
            <div class="auth-header">
                <img src="LOGO - logistiXnerd dude.png" alt="LogistiXnerd" class="auth-brand-icon">
                <img src="LOGO - logistiXnerd text.png" alt="LogistiXnerd" class="auth-brand-text">
                <h1 class="auth-title" id="authTitle">IFTA Wizard</h1>
            </div>
            
            <div class="auth-social">
                <button type="button" class="btn-social btn-google" id="googleSignIn" onclick="IFTAAuth.handleGoogleSignIn()">
                    <svg viewBox="0 0 24 24" width="14" height="14">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>
            </div>
            
            <div class="auth-divider">
                <span>or</span>
            </div>
            
            <!-- Auth Mode Toggle -->
            <div class="auth-mode-toggle">
                <button type="button" class="auth-mode-btn active" data-mode="signin">Sign In</button>
                <button type="button" class="auth-mode-btn" data-mode="signup">Create Account</button>
            </div>
            
            <form id="authForm" class="auth-form" novalidate>
                <!-- Sign In Fields -->
                <div class="signin-fields">
                    <div class="form-group">
                        <label for="signinEmail">Email</label>
                        <input type="email" id="signinEmail" placeholder="you@company.com">
                    </div>
                    <div class="form-group">
                        <label for="signinPassword">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="signinPassword" placeholder="Enter your password">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signinPassword', this)" aria-label="Show password">Show</button>
                        </div>
                    </div>
                    <div class="form-group remember-me">
                        <label class="checkbox-label">
                            <input type="checkbox" id="savePassword">
                            <span>Save password</span>
                        </label>
                    </div>
                    <a href="admin.html" id="adminPanelLink" class="admin-panel-link" style="display: none;">go to admin console</a>
                    <button type="button" class="forgot-password" id="forgotPasswordBtn" onclick="IFTAAuth.showForgotPassword()">Forgot password?</button>
                    <button type="submit" class="btn btn-primary btn-full">Sign In</button>
                </div>
                
                <!-- Sign Up Fields (hidden by default) -->
                <div class="signup-fields" style="display: none;">
                    <div class="form-group">
                        <label for="authEmail">Email</label>
                        <input type="email" id="authEmail" placeholder="you@company.com">
                    </div>
                    <div class="form-group">
                        <label for="authPassword">Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="authPassword" placeholder="Create a password" oninput="checkPasswordRequirements(this.value)">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('authPassword', this)" aria-label="Show password">Show</button>
                        </div>
                        <div class="password-requirements" id="passwordRequirements">
                            <span class="req" id="req-length">‚Ä¢ 6+ characters</span>
                            <span class="req" id="req-upper">‚Ä¢ 1 uppercase</span>
                            <span class="req" id="req-lower">‚Ä¢ 1 lowercase</span>
                            <span class="req" id="req-number">‚Ä¢ 1 number</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="authPasswordConfirm">Confirm Password</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="authPasswordConfirm" placeholder="Confirm your password">
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('authPasswordConfirm', this)" aria-label="Show password">Show</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="authName">Full Name</label>
                        <input type="text" id="authName" placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label for="authCompany">Company Name <span class="optional">(optional)</span></label>
                        <input type="text" id="authCompany" placeholder="ABC Trucking LLC">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">Create Account</button>
                </div>
            </form>
            
            <p class="auth-terms">By continuing, you agree to our <a href="terms.html" target="_blank">Terms</a> and <a href="privacy.html" target="_blank">Privacy Policy</a></p>
            <p class="auth-tagline">Calculate quarterly IFTA for your company, or prepare reports for your owner operators' trucks.</p>
            <p class="auth-about"><a href="about.html" target="_blank">About IFTA Wizard</a> ‚Äî Built by a fleet manager, not a tech company.</p>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="forgotPasswordTitle">
        <div class="forgot-password-modal">
            <button class="modal-close" onclick="IFTAAuth.closeForgotPassword()" aria-label="Close">&times;</button>
            
            <h2 id="forgotPasswordTitle">reset password</h2>
            
            <!-- Step 1: Enter Email -->
            <div id="forgotStep1" class="forgot-step">
                <p class="forgot-description">enter your email address to reset your password</p>
                <div class="form-group">
                    <label for="forgotEmail">email</label>
                    <input type="email" id="forgotEmail" placeholder="you@company.com">
                </div>
                <p id="forgotEmailError" class="forgot-error" style="display: none;"></p>
                <button class="btn btn-primary btn-full" onclick="IFTAAuth.verifyForgotEmail()">continue</button>
                <button class="btn btn-link" onclick="IFTAAuth.closeForgotPassword()">back to sign in</button>
            </div>
            
            <!-- Step 2: Email Verification Code -->
            <div id="forgotStep2" class="forgot-step" style="display: none;">
                <p class="forgot-description">enter the 6-digit code sent to your email</p>
                <div class="forgot-user-info">
                    <span class="forgot-user-avatar" id="forgotUserAvatar">J</span>
                    <span class="forgot-user-name" id="forgotUserName">you@email.com</span>
                </div>
                <div class="code-input-container" id="forgotCodeInputs">
                    <input type="text" class="code-input" maxlength="1" data-index="0" inputmode="numeric">
                    <input type="text" class="code-input" maxlength="1" data-index="1" inputmode="numeric">
                    <input type="text" class="code-input" maxlength="1" data-index="2" inputmode="numeric">
                    <input type="text" class="code-input" maxlength="1" data-index="3" inputmode="numeric">
                    <input type="text" class="code-input" maxlength="1" data-index="4" inputmode="numeric">
                    <input type="text" class="code-input" maxlength="1" data-index="5" inputmode="numeric">
                </div>
                <p id="forgotCodeError" class="forgot-error" style="display: none;"></p>
                <button class="btn btn-primary btn-full" onclick="IFTAAuth.verifyForgotCode()">verify code</button>
                <button class="btn btn-link" id="forgotResendBtn" onclick="IFTAAuth.resendForgotCode()">resend code <span id="forgotResendTimer"></span></button>
            </div>
            
            <!-- Step 3: Create New Password -->
            <div id="forgotStep3" class="forgot-step" style="display: none;">
                <p class="forgot-description">create a new password</p>
                <div class="form-group">
                    <label for="forgotNewPassword">new password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="forgotNewPassword" placeholder="min 6 characters">
                        <button type="button" class="password-toggle" onclick="IFTAAuth.togglePasswordVisibility('forgotNewPassword')">üëÅ</button>
                    </div>
                    <div class="password-strength" id="passwordStrength"></div>
                </div>
                <div class="form-group">
                    <label for="forgotConfirmPassword">confirm password</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="forgotConfirmPassword" placeholder="confirm password">
                        <button type="button" class="password-toggle" onclick="IFTAAuth.togglePasswordVisibility('forgotConfirmPassword')">üëÅ</button>
                    </div>
                </div>
                <button class="btn btn-primary btn-full" onclick="IFTAAuth.resetPasswordSubmit()">reset password</button>
            </div>
            
            <!-- Step 4: Success -->
            <div id="forgotStep4" class="forgot-step" style="display: none;">
                <div class="success-icon"></div>
                <h3>password reset</h3>
                <p class="forgot-description">your password has been updated. you can now sign in.</p>
                <button class="btn btn-primary btn-full" onclick="IFTAAuth.closeForgotPassword()">sign in</button>
            </div>
        </div>
    </div>

    <!-- Email Verification Modal (for signup verification & 2FA) -->
    <div id="emailVerifyModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="verifyTitle">
        <div class="verify-modal">
            <button class="verify-close" onclick="IFTAAuth.closeEmailVerify()" aria-label="Close">&times;</button>
            
            <div class="verify-icon" id="verifyIcon"></div>
            <h2 class="verify-title" id="verifyTitle">Verify Your Email</h2>
            <p class="verify-subtitle" id="verifyDescription">We sent a code to <strong id="verifyEmailDisplay">your@email.com</strong></p>
            
            <div class="code-input-container" id="verifyCodeInputs">
                <input type="text" class="code-input" maxlength="1" data-index="0" inputmode="numeric" autocomplete="one-time-code">
                <input type="text" class="code-input" maxlength="1" data-index="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="2" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="3" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="4" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" data-index="5" inputmode="numeric">
            </div>
            
            <div id="verifyError" class="verify-error" style="display: none;"></div>
            
            <button class="verify-btn" id="verifyCodeBtn" onclick="IFTAAuth.verifyEmailCode()">Verify</button>
            
            <p class="verify-resend">
                Didn't get it? 
                <button class="verify-resend-btn" id="resendCodeBtn" onclick="IFTAAuth.resendVerificationCode()">Resend</button>
                <span class="verify-timer" id="resendTimer"></span>
            </p>
        </div>
    </div>

    <!-- TOTP Setup Modal (for enabling authenticator app) -->
    <div id="totpSetupModal" class="modal-overlay hidden">
        <div class="verify-modal totp-modal">
            <button class="verify-close" onclick="IFTAAuth.closeTOTPSetup()">&times;</button>
            
            <div class="verify-icon"></div>
            <h2 class="verify-title">Setup Authenticator</h2>
            <p class="verify-subtitle">Scan this QR code with Microsoft Authenticator, Google Authenticator, or any TOTP app</p>
            
            <div class="totp-qr-container">
                <img id="totpQRCode" src="" alt="QR Code" class="totp-qr">
            </div>
            
            <div class="totp-secret">
                <p class="totp-secret-label">Or enter this code manually:</p>
                <code id="totpSecretKey" class="totp-secret-code">XXXX XXXX XXXX XXXX XXXX</code>
                <p class="totp-account">Account: <strong id="totpEmail">your@email.com</strong></p>
            </div>
            
            <p class="verify-subtitle" style="margin-top: 1rem;">Enter the 6-digit code from your app:</p>
            
            <div class="code-input-container" id="totpSetupCodeInputs">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
            </div>
            
            <div id="totpSetupError" class="verify-error totp-error" style="display: none;"></div>
            
            <button class="verify-btn" onclick="IFTAAuth.verifyTOTPSetup()">Enable Authenticator</button>
        </div>
    </div>

    <!-- TOTP Verify Modal (for login with authenticator) -->
    <div id="totpVerifyModal" class="modal-overlay hidden">
        <div class="verify-modal totp-modal">
            <button class="verify-close" onclick="IFTAAuth.closeTOTPVerify()">&times;</button>
            
            <div class="verify-icon"></div>
            <h2 class="verify-title">Two-Factor Authentication</h2>
            <p class="verify-subtitle">Enter the 6-digit code from your authenticator app for <strong id="totpVerifyEmail">your@email.com</strong></p>
            
            <div class="code-input-container" id="totpVerifyCodeInputs">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
                <input type="text" class="code-input" maxlength="1" inputmode="numeric">
            </div>
            
            <div id="totpVerifyError" class="verify-error totp-error" style="display: none;"></div>
            
            <button class="verify-btn" onclick="IFTAAuth.verifyTOTPLogin()">Verify</button>
            
            <p class="totp-help">
                <small>Open your Microsoft Authenticator, Google Authenticator, or other TOTP app to get your code.</small>
            </p>
        </div>
    </div>

    <div class="app-container" style="display: none;">
        <!-- Header -->
        <header class="header" role="banner">
            <div class="header-content">
                <div class="logo">
                    <h1>IFTA Wizard</h1>
                </div>
                <div class="header-info">
                    <div class="quarter-dropdown">
                        <select id="headerQuarterSelect" class="quarter-select">
                            <!-- Populated dynamically by JavaScript -->
                        </select>
                    </div>
                    <span class="rate-status" id="rateStatus" title="Rate data status">
                        <span class="status-dot"></span>
                        <span class="status-text">Verifying...</span>
                    </span>
                    <!-- Profile Dropdown -->
                    <div class="profile-dropdown" id="profileDropdown">
                        <button class="btn btn-secondary btn-sm profile-btn" id="profileBtn" aria-haspopup="true" aria-expanded="false">
                            <span class="profile-avatar" id="profileAvatar">U</span>
                            <span class="profile-name" id="profileName">Account</span>
                        </button>
                        <div class="profile-menu" id="profileMenu" role="menu" aria-label="Account menu">
                            <div class="profile-menu-header">
                                <div class="profile-info">
                                    <span class="profile-user-name" id="menuUserName">User</span>
                                    <span class="profile-user-email" id="menuUserEmail">user@email.com</span>
                                </div>
                            </div>
                            <div class="profile-menu-items">
                                <a href="admin.html" class="profile-menu-item" id="menuAdminConsole" style="display: none;">
                                    <span>Admin Console</span>
                                </a>
                                <button class="profile-menu-item" id="menuSetupTOTP" style="display: none;">
                                    <span>Setup Authenticator</span>
                                </button>
                                <button class="profile-menu-item" id="menuSavedReports">
                                    <span>Saved Reports</span>
                                    <span class="menu-badge" id="reportsCount">0</span>
                                </button>
                                <button class="profile-menu-item" id="menuProfile">
                                    <span>Profile Settings</span>
                                </button>
                                <button class="profile-menu-item" id="menuPreferences">
                                    <span>Preferences</span>
                                </button>
                                <div class="profile-menu-divider"></div>
                                <button class="profile-menu-item menu-item-danger" id="menuLogout">
                                    <span>Log Out</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" role="main">
            <!-- Configuration Panel -->
            <section class="config-panel card">
                <h2>Trip Configuration</h2>
                <div class="config-grid">
                    <div class="form-group">
                        <label for="unitNumber" data-tooltip="Enter truck/trailer number for per-unit reports, or leave blank for all units">Unit # <span class="optional-hint">(or "All Units")</span></label>
                        <input type="text" id="unitNumber" placeholder="e.g., 101 or All Units">
                    </div>
                    <div class="form-group">
                        <label for="fuelType" data-tooltip="Primary fuel type used by this unit">Fuel Type</label>
                        <select id="fuelType">
                            <option value="diesel" selected>Diesel</option>
                            <option value="gasoline">Gasoline</option>
                            <option value="gasohol">Gasohol</option>
                            <option value="propane">Propane (LPG)</option>
                            <option value="lng">LNG</option>
                            <option value="cng">CNG</option>
                            <option value="ethanol">Ethanol (E-85)</option>
                            <option value="methanol">Methanol (M-85)</option>
                            <option value="biodiesel">Biodiesel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="baseJurisdiction" data-tooltip="Your home state/province where you're registered for IFTA">Base Jurisdiction <span class="required">*</span></label>
                        <select id="baseJurisdiction" required>
                            <option value="">Select...</option>
                            <!-- Populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fleetMpg" data-tooltip="Average MPG from your previous IFTA filings (used to calculate Taxable Gallons)">Fleet MPG <span class="mpg-hint">(from history)</span></label>
                        <input type="number" id="fleetMpg" step="0.01" value="6.5" min="1" max="20">
                    </div>
                    <div class="form-group">
                        <label for="currentMpg" data-tooltip="Calculated automatically: Total Miles √∑ Total Tax Paid Gallons">Current MPG <span class="mpg-hint">(this report)</span></label>
                        <input type="text" id="currentMpg" value="‚Äî" readonly class="mpg-calculated">
                    </div>
                </div>
            </section>

            <!-- Data Entry Table -->
            <section class="data-section card">
                <div class="section-header">
                    <h2>Jurisdiction Data Entry</h2>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="addRow">Add Row</button>
                        <button class="btn btn-secondary" id="clearAll">Clear</button>
                        <button class="btn btn-secondary" id="importData">Import</button>
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="dataTable" aria-label="Jurisdiction fuel tax data">
                        <thead>
                            <tr>
                                <th class="col-jurisdiction" data-tooltip="State or province where you traveled">Jurisdiction</th>
                                <th class="col-miles" data-tooltip="All miles driven in this jurisdiction (including non-taxable)">Total Miles</th>
                                <th class="col-taxable" data-tooltip="Miles on public roads (usually same as Total Miles)">Taxable Miles</th>
                                <th class="col-gallons" data-tooltip="Gallons of fuel you purchased IN this jurisdiction">Tax Paid Gal</th>
                                <th class="col-rate" data-tooltip="IFTA tax rate per gallon (auto-filled)">Rate</th>
                                <th class="col-taxable-gal" data-tooltip="Taxable Miles √∑ Fleet MPG (calculated)">Taxable Gal</th>
                                <th class="col-net-gal" data-tooltip="Taxable Gal ‚àí Tax Paid Gal (calculated)">Net Gal</th>
                                <th class="col-tax" data-tooltip="Net Gal √ó Rate = amount owed or credited">Tax Due</th>
                                <th class="col-actions"></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Rows populated by JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td>Totals</td>
                                <td id="totalMiles" data-tooltip="Sum of all Total Miles">0</td>
                                <td id="totalTaxableMiles" data-tooltip="Sum of all Taxable Miles">0</td>
                                <td id="totalGallons" data-tooltip="Sum of all fuel purchased">0</td>
                                <td>‚Äî</td>
                                <td id="totalTaxableGallons" data-tooltip="Sum of all calculated Taxable Gallons">0</td>
                                <td id="totalNetGallons" data-tooltip="Total Taxable ‚àí Total Purchased">0</td>
                                <td id="totalTax" class="tax-amount" data-tooltip="Total amount owed (positive) or credit (negative)">$0.00</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Inline Summary Bar -->
                <div class="inline-summary">
                    <div class="summary-item" data-tooltip="Total miles driven across all jurisdictions">
                        <span class="summary-label">Miles</span>
                        <span class="summary-value" id="summaryMiles">0</span>
                    </div>
                    <div class="summary-item" data-tooltip="Total fuel purchased across all jurisdictions">
                        <span class="summary-label">Gallons</span>
                        <span class="summary-value" id="summaryGallons">0</span>
                    </div>
                    <div class="summary-item" data-tooltip="Miles per Gallon for this quarter (Total Miles √∑ Total Gallons)">
                        <span class="summary-label">MPG</span>
                        <span class="summary-value" id="summaryMpg">0</span>
                    </div>
                    <div class="summary-item highlight" data-tooltip="Total tax owed to all jurisdictions combined">
                        <span class="summary-label">Net Tax</span>
                        <span class="summary-value" id="summaryTax">$0.00</span>
                    </div>
                </div>
            </section>

            <!-- Export Section - Right Below Data -->
            <section class="export-section card">
                <div class="export-row">
                    <span class="export-label">Export:</span>
                    <div class="export-buttons">
                        <button class="btn btn-primary btn-sm" id="exportPdf">PDF</button>
                        <button class="btn btn-secondary btn-sm" id="exportCsv">CSV</button>
                        <button class="btn btn-secondary btn-sm" id="exportExcel">Excel</button>
                        <button class="btn btn-secondary btn-sm" id="printReport">Print</button>
                        <div class="export-divider"></div>
                        <button class="btn btn-secondary btn-sm" id="sendEmail">Email</button>
                        <button class="btn btn-secondary btn-sm" id="saveToDrive">Drive</button>
                        <div class="export-divider"></div>
                        <button class="btn btn-success btn-sm" id="saveReport">Save Report</button>
                    </div>
                </div>
            </section>

            <!-- Tax Rates Reference -->
            <section class="rates-section card">
                <div class="section-header">
                    <h2>Tax Rates Reference</h2>
                    <div class="rates-info">
                        <span class="system-health" id="systemHealth" title="System status">
                            <span class="health-dot"></span>
                            <span class="health-text">OK</span>
                        </span>
                        <span id="exchangeRate">USD/CAD: 1.38</span>
                        <span id="lastUpdated">Updated: ‚Äî</span>
                    </div>
                </div>
                <div class="rates-filter">
                    <input type="text" id="ratesSearch" placeholder="Search...">
                    <select id="countryFilter">
                        <option value="all">All</option>
                        <option value="US">US</option>
                        <option value="CAN">Canada</option>
                    </select>
                </div>
                <div class="rates-table-container">
                    <table id="ratesTable" aria-label="Tax rates reference">
                        <thead>
                            <tr>
                                <th>Jurisdiction</th>
                                <th>Country</th>
                                <th>Diesel</th>
                                <th>Gasoline</th>
                                <th>Gasohol</th>
                                <th>Propane</th>
                                <th>LNG</th>
                                <th>CNG</th>
                            </tr>
                        </thead>
                        <tbody id="ratesTableBody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>IFTA Wizard 2025 | <a href="https://www.iftach.org/taxmatrix4/" target="_blank">IFTA, Inc.</a></p>
            <p class="disclaimer">For estimation only. Verify rates before filing.</p>
        </footer>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container" role="alert" aria-live="polite"></div>

    <!-- Hidden quarter select for compatibility -->
    <select id="quarterSelect" style="display: none;"></select>

    <!-- Saved Reports Modal -->
    <div id="savedReportsModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="savedReportsTitle">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 id="savedReportsTitle">Saved Reports</h2>
                <button class="modal-close" id="closeReportsModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="reports-toolbar">
                    <div class="reports-search">
                        <input type="text" id="reportsSearch" placeholder="Search reports...">
                    </div>
                    <div class="reports-actions">
                        <button class="btn btn-secondary btn-sm" id="exportSelectedReports">Export Selected</button>
                        <button class="btn btn-danger btn-sm" id="deleteSelectedReports">Delete Selected</button>
                    </div>
                </div>
                <div class="reports-list" id="reportsList">
                    <!-- Reports populated by JavaScript -->
                    <div class="reports-empty">
                        <p>No saved reports yet</p>
                        <small>Save your first report to see it here</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="emailModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="emailModalTitle">Email Report</h2>
                <button class="modal-close" id="closeEmailModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="emailForm">
                    <div class="form-group">
                        <label for="emailTo">Send To</label>
                        <input type="email" id="emailTo" placeholder="recipient@company.com" required>
                    </div>
                    <div class="form-group">
                        <label for="emailCc">CC (optional)</label>
                        <input type="email" id="emailCc" placeholder="cc@company.com">
                    </div>
                    <div class="form-group">
                        <label for="emailSubject">Subject</label>
                        <input type="text" id="emailSubject" value="IFTA Report">
                    </div>
                    <div class="form-group">
                        <label for="emailMessage">Message (optional)</label>
                        <textarea id="emailMessage" rows="3" placeholder="Add a message..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Attach Reports</label>
                        <div class="email-attachments" id="emailAttachments">
                            <label class="checkbox-label">
                                <input type="checkbox" id="attachCurrent" checked>
                                <span>Current Report (PDF)</span>
                            </label>
                        </div>
                        <div class="saved-reports-attach" id="savedReportsAttach">
                            <!-- Saved reports checkboxes populated by JS -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelEmail">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Email</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Google Drive Modal -->
    <div id="driveModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="driveModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="driveModalTitle">Save to Google Drive</h2>
                <button class="modal-close" id="closeDriveModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="driveNotConnected" class="drive-connect">
                    <p>Connect your Google Drive to save reports</p>
                    <button class="btn btn-primary" id="connectDrive">
                        <svg viewBox="0 0 24 24" width="16" height="16" style="margin-right: 6px;">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Connect Google Drive
                    </button>
                </div>
                <div id="driveConnected" class="drive-save hidden">
                    <div class="drive-user">
                        <span>Connected as: </span>
                        <strong id="driveUserEmail">user@gmail.com</strong>
                    </div>
                    <div class="form-group">
                        <label for="driveFolderName">Folder Name</label>
                        <input type="text" id="driveFolderName" value="IFTA Reports">
                    </div>
                    <div class="form-group">
                        <label>Select Reports to Save</label>
                        <div class="drive-reports" id="driveReportsList">
                            <label class="checkbox-label">
                                <input type="checkbox" id="driveCurrentReport" checked>
                                <span>Current Report</span>
                            </label>
                        </div>
                        <div class="drive-saved-reports" id="driveSavedReports">
                            <!-- Saved reports populated by JS -->
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="disconnectDrive">Disconnect</button>
                        <button type="button" class="btn btn-primary" id="saveToDriveBtn">Save to Drive</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Settings Modal -->
    <div id="profileModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="profileModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="profileModalTitle">Profile Settings</h2>
                <button class="modal-close" id="closeProfileModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="profileForm">
                    <div class="form-group">
                        <label for="profileEmail">Email</label>
                        <input type="email" id="profileEmail" readonly>
                    </div>
                    <div class="form-group">
                        <label for="profileFullName">Full Name</label>
                        <input type="text" id="profileFullName" required>
                    </div>
                    <div class="form-group">
                        <label for="profileCompany">Company Name</label>
                        <input type="text" id="profileCompany">
                    </div>
                    <div class="form-group">
                        <label for="profilePhone">Phone Number</label>
                        <input type="tel" id="profilePhone">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="profileFleetSize">Fleet Size</label>
                            <select id="profileFleetSize">
                                <option value="">Select...</option>
                                <option value="1-5">1-5 trucks</option>
                                <option value="6-20">6-20 trucks</option>
                                <option value="21-50">21-50 trucks</option>
                                <option value="51-100">51-100 trucks</option>
                                <option value="100+">100+ trucks</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="profileDriverCount">Drivers</label>
                            <input type="number" id="profileDriverCount" min="1">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelProfile">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Preferences Modal -->
    <div id="preferencesModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="preferencesModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="preferencesModalTitle">Preferences</h2>
                <button class="modal-close" id="closePreferencesModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="preference-section">
                    <h3>Default Settings</h3>
                    <div class="form-group">
                        <label for="prefFuelType">Default Fuel Type</label>
                        <select id="prefFuelType">
                            <option value="diesel">Diesel</option>
                            <option value="gasoline">Gasoline</option>
                            <option value="gasohol">Gasohol</option>
                            <option value="propane">Propane (LPG)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prefBaseJurisdiction">Default Base Jurisdiction</label>
                        <select id="prefBaseJurisdiction">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="prefMpg">Default Fleet MPG</label>
                        <input type="number" id="prefMpg" step="0.1" value="6.5" min="1" max="20">
                    </div>
                </div>
                <div class="preference-section">
                    <h3>Auto-Save</h3>
                    <label class="checkbox-label">
                        <input type="checkbox" id="prefAutoSave" checked>
                        <span>Automatically save data locally</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="prefAutoBackup">
                        <span>Auto-backup reports to Google Drive</span>
                    </label>
                </div>
                <div class="preference-section">
                    <h3>Notifications</h3>
                    <label class="checkbox-label">
                        <input type="checkbox" id="prefEmailReminders" checked>
                        <span>Email reminders for quarterly filing</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="prefRateAlerts" checked>
                        <span>Alert when tax rates change</span>
                    </label>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelPreferences">Cancel</button>
                    <button type="button" class="btn btn-primary" id="savePreferences">Save Preferences</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Report Modal -->
    <div id="saveReportModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="saveReportModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="saveReportModalTitle">Save Report</h2>
                <button class="modal-close" id="closeSaveReportModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="saveReportForm">
                    <div class="form-group">
                        <label for="reportName">Report Name</label>
                        <input type="text" id="reportName" placeholder="Q4 2025 Report" required>
                    </div>
                    <div class="form-group">
                        <label for="reportNotes">Notes (optional)</label>
                        <textarea id="reportNotes" rows="2" placeholder="Add any notes..."></textarea>
                    </div>
                    
                    <!-- Report Options -->
                    <div class="form-group">
                        <label class="section-label">Include in Report:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" id="includeFleetMpg" checked>
                                <span>Fleet MPG</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="includeCurrentMpg" checked>
                                <span>Current MPG (calculated)</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="includeUnitNumber" checked>
                                <span>Unit Number</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="includeTaxRates">
                                <span>Tax Rates Reference Table</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="includeSummary" checked>
                                <span>Summary Totals</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="report-preview">
                        <div class="preview-item">
                            <span class="preview-label">Quarter:</span>
                            <span class="preview-value" id="previewQuarter">Q4 2025</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">Jurisdictions:</span>
                            <span class="preview-value" id="previewJurisdictions">0</span>
                        </div>
                        <div class="preview-item">
                            <span class="preview-label">Total Tax:</span>
                            <span class="preview-value" id="previewTax">$0.00</span>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancelSaveReport">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Export PDF Options Modal -->
    <div id="exportPdfModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="exportPdfModalTitle">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2 id="exportPdfModalTitle">Export to PDF</h2>
                <button class="modal-close" id="closeExportPdfModal" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="section-label">Include in PDF:</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="pdfIncludeUnitNumber" checked>
                            <span>Unit Number</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="pdfIncludeFleetMpg" checked>
                            <span>Fleet MPG</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="pdfIncludeCurrentMpg" checked>
                            <span>Current MPG (calculated)</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="pdfIncludeTaxRates">
                            <span>Tax Rates Reference Table</span>
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="pdfIncludeSummary" checked>
                            <span>Summary Section</span>
                        </label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelExportPdf">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmExportPdf">Export PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <script src="firebase-config.js"></script>
    <script src="security.js"></script>
    <script src="tax-rates.js"></script>
    <script src="integrity-monitor.js"></script>
    <script src="app.js"></script>
    
    <!-- Password helpers -->
    <script>
    function togglePasswordVisibility(inputId, btn) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
            btn.textContent = 'Hide';
        } else {
            input.type = 'password';
            btn.textContent = 'Show';
        }
    }
    
    function checkPasswordRequirements(password) {
        const reqs = {
            'req-length': password.length >= 6,
            'req-upper': /[A-Z]/.test(password),
            'req-lower': /[a-z]/.test(password),
            'req-number': /[0-9]/.test(password)
        };
        
        for (const [id, valid] of Object.entries(reqs)) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('valid', valid);
        }
    }
    </script>
    
    <script src="auth-firebase.js"></script>
    <script src="reports.js"></script>
</body>
</html>
