<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFTA Wizard - Export Test Suite</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 30px;
            background: linear-gradient(135deg, #1a1c2e 0%, #2d3250 100%);
            min-height: 100vh;
            color: #fff;
        }
        h1 { margin-bottom: 10px; color: #60a5fa; }
        .subtitle { color: #94a3b8; margin-bottom: 30px; }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
        }
        .test-card h3 {
            color: #60a5fa;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .test-card p {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59,130,246,0.4); }
        .btn-success { background: #10b981; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        .status { 
            margin-top: 10px; 
            padding: 8px 12px; 
            border-radius: 6px; 
            font-size: 13px;
            display: none;
        }
        .status.show { display: block; }
        .status.success { background: rgba(16,185,129,0.2); color: #10b981; }
        .status.error { background: rgba(239,68,68,0.2); color: #ef4444; }
        .status.info { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .results {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        .results h2 { color: #60a5fa; margin-bottom: 15px; }
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .result-item:last-child { border-bottom: none; }
        .result-pass { color: #10b981; }
        .result-fail { color: #ef4444; }
        .link { color: #60a5fa; text-decoration: none; }
        .link:hover { text-decoration: underline; }
        .warning-box {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üìã Export & Reports Test Suite v1.1</h1>
    <p class="subtitle">Verify all export and reporting functions are working correctly</p>
    
    <div class="warning-box">
        ‚ö†Ô∏è <strong>Note:</strong> PDF export may be blocked by popup blockers. If a test fails, try allowing popups for this site.
    </div>
    
    <div class="test-grid">
        <!-- PDF Export Test -->
        <div class="test-card">
            <h3>üìÑ PDF Export</h3>
            <p>Opens a print-ready report in a new window. Use your browser's "Save as PDF" option.</p>
            <button class="btn btn-primary" onclick="testPdfExport()">Test PDF Export</button>
            <div class="status" id="pdfStatus"></div>
        </div>
        
        <!-- CSV Export Test -->
        <div class="test-card">
            <h3>üìä CSV Export</h3>
            <p>Downloads a comma-separated values file that can be opened in any spreadsheet app.</p>
            <button class="btn btn-primary" onclick="testCsvExport()">Test CSV Export</button>
            <div class="status" id="csvStatus"></div>
        </div>
        
        <!-- Excel Export Test -->
        <div class="test-card">
            <h3>üìà Excel Export</h3>
            <p>Downloads an Excel-compatible file with header information and formatted data.</p>
            <button class="btn btn-primary" onclick="testExcelExport()">Test Excel Export</button>
            <div class="status" id="excelStatus"></div>
        </div>
        
        <!-- Print Test -->
        <div class="test-card">
            <h3>üñ®Ô∏è Print Report</h3>
            <p>Opens the browser's print dialog for the current page (works best on main app).</p>
            <button class="btn btn-primary" onclick="testPrint()">Test Print</button>
            <div class="status" id="printStatus"></div>
        </div>
        
        <!-- Save Session Test -->
        <div class="test-card">
            <h3>üíæ Save Session</h3>
            <p>Saves all current data to browser's localStorage for later recovery.</p>
            <button class="btn btn-primary" onclick="testSave()">Test Save</button>
            <div class="status" id="saveStatus"></div>
        </div>
        
        <!-- Load Session Test -->
        <div class="test-card">
            <h3>üìÇ Load Session</h3>
            <p>Restores previously saved data from localStorage.</p>
            <button class="btn btn-primary" onclick="testLoad()">Test Load</button>
            <div class="status" id="loadStatus"></div>
        </div>
    </div>
    
    <!-- Quick Test with Sample Data -->
    <div class="test-card" style="margin-bottom: 20px;">
        <h3>üöÄ Run All Tests with Sample Data</h3>
        <p>Creates sample trip data and tests all export functions automatically.</p>
        <button class="btn btn-success" onclick="runAllTests()">Run All Tests</button>
        <button class="btn btn-warning" onclick="openMainApp()">Open Main App</button>
        <button class="btn btn-primary" style="margin-left: 10px;" onclick="clearTestData()">Clear Test Data</button>
    </div>
    
    <div class="results" id="results" style="display: none;">
        <h2>Test Results</h2>
        <div id="resultsContent"></div>
    </div>
    
    <!-- Load the app scripts for testing -->
    <script src="tax-rates.js"></script>
    <script>
        'use strict';
        
        // Test application state with realistic data
        const testAppState = {
            rows: [
                { id: 1, jurisdiction: 'TX', totalMiles: 5000, taxableMiles: 5000, taxPaidGallons: 400, taxRate: 0.20, taxableGallons: 769.231, netTaxableGallons: 369.231, taxDue: 73.85 },
                { id: 2, jurisdiction: 'OK', totalMiles: 2000, taxableMiles: 2000, taxPaidGallons: 150, taxRate: 0.19, taxableGallons: 307.692, netTaxableGallons: 157.692, taxDue: 29.96 },
                { id: 3, jurisdiction: 'NM', totalMiles: 1500, taxableMiles: 1500, taxPaidGallons: 100, taxRate: 0.21, taxableGallons: 230.769, netTaxableGallons: 130.769, taxDue: 27.46 },
                { id: 4, jurisdiction: 'CA', totalMiles: 800, taxableMiles: 800, taxPaidGallons: 200, taxRate: 0.98, taxableGallons: 123.077, netTaxableGallons: -76.923, taxDue: -75.38 }
            ],
            selectedFuelType: 'diesel',
            selectedQuarter: '4Q2025',
            baseJurisdiction: 'TX',
            fleetMpg: 6.5,
            rowIdCounter: 4
        };
        
        const results = {};
        
        function showStatus(id, message, type) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = message;
                el.className = `status show ${type}`;
            }
        }
        
        function testPdfExport() {
            try {
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                
                if (!printWindow || printWindow.closed || typeof printWindow.closed === 'undefined') {
                    results.pdf = false;
                    showStatus('pdfStatus', '‚ö† Popup blocked - please allow popups', 'error');
                    return;
                }
                
                let html = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>IFTA Report - Test</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h1 { color: #2563eb; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                            th { background: #f4f4f4; }
                            .totals { background: #e8f5e9; font-weight: bold; }
                            .positive { color: #c62828; }
                            .negative { color: #2e7d32; }
                        </style>
                    </head>
                    <body>
                        <h1>IFTA Fuel Tax Report (Test)</h1>
                        <p><strong>Quarter:</strong> Q4 2025</p>
                        <p><strong>Fuel Type:</strong> Diesel</p>
                        <p><strong>Fleet MPG:</strong> 6.5</p>
                        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                        <table>
                            <tr><th>Jurisdiction</th><th>Miles</th><th>Taxable Gallons</th><th>Net Gallons</th><th>Rate</th><th>Tax Due</th></tr>
                `;
                
                let totalTax = 0;
                testAppState.rows.forEach(row => {
                    const taxClass = row.taxDue >= 0 ? 'positive' : 'negative';
                    html += `<tr>
                        <td>${IFTA_TAX_RATES.jurisdictions[row.jurisdiction]?.name || row.jurisdiction} (${row.jurisdiction})</td>
                        <td>${row.totalMiles.toLocaleString()}</td>
                        <td>${row.taxableGallons.toFixed(3)}</td>
                        <td>${row.netTaxableGallons.toFixed(3)}</td>
                        <td>$${row.taxRate.toFixed(4)}</td>
                        <td class="${taxClass}">${row.taxDue >= 0 ? '$' : '-$'}${Math.abs(row.taxDue).toFixed(2)}</td>
                    </tr>`;
                    totalTax += row.taxDue;
                });
                
                const totalClass = totalTax >= 0 ? 'positive' : 'negative';
                html += `<tr class="totals">
                    <td>TOTALS</td>
                    <td>${testAppState.rows.reduce((s,r) => s + r.totalMiles, 0).toLocaleString()}</td>
                    <td>${testAppState.rows.reduce((s,r) => s + r.taxableGallons, 0).toFixed(3)}</td>
                    <td>${testAppState.rows.reduce((s,r) => s + r.netTaxableGallons, 0).toFixed(3)}</td>
                    <td>‚Äî</td>
                    <td class="${totalClass}">${totalTax >= 0 ? '$' : '-$'}${Math.abs(totalTax).toFixed(2)}</td>
                </tr>`;
                
                html += `</table>
                        <p style="margin-top: 30px; color: #666; font-size: 12px;">
                            ‚úì PDF Export Test Successful<br>
                            Generated by IFTA Wizard | Disclaimer: For estimation purposes only.
                        </p>
                    </body>
                    </html>`;
                
                printWindow.document.write(html);
                printWindow.document.close();
                
                results.pdf = true;
                showStatus('pdfStatus', '‚úì PDF window opened successfully', 'success');
            } catch (error) {
                results.pdf = false;
                showStatus('pdfStatus', '‚úï Error: ' + error.message, 'error');
            }
        }
        
        function testCsvExport() {
            try {
                // BOM for UTF-8
                let csv = '\uFEFF';
                csv += 'Jurisdiction,Total Miles,Taxable Miles,Tax Paid Gallons,Tax Rate,Taxable Gallons,Net Taxable Gallons,Tax Due\n';
                
                testAppState.rows.forEach(row => {
                    const name = IFTA_TAX_RATES.jurisdictions[row.jurisdiction]?.name || row.jurisdiction;
                    csv += `"${name} (${row.jurisdiction})",${row.totalMiles},${row.taxableMiles},${row.taxPaidGallons},${row.taxRate.toFixed(4)},${row.taxableGallons.toFixed(3)},${row.netTaxableGallons.toFixed(3)},${row.taxDue.toFixed(2)}\n`;
                });
                
                downloadFile(csv, 'ifta-test-report.csv', 'text/csv;charset=utf-8');
                results.csv = true;
                showStatus('csvStatus', '‚úì CSV file downloaded', 'success');
            } catch (error) {
                results.csv = false;
                showStatus('csvStatus', '‚úï Error: ' + error.message, 'error');
            }
        }
        
        function testExcelExport() {
            try {
                let csv = '\uFEFF';
                csv += 'IFTA Fuel Tax Report\n';
                csv += 'Quarter:,Q4 2025\n';
                csv += 'Fuel Type:,Diesel\n';
                csv += 'Fleet MPG:,6.5\n';
                csv += 'Base Jurisdiction:,TX\n';
                csv += `Generated:,${new Date().toLocaleString()}\n\n`;
                csv += 'Jurisdiction,Total Miles,Taxable Miles,Tax Paid Gallons,Tax Rate,Taxable Gallons,Net Taxable Gallons,Tax Due\n';
                
                let totals = { miles: 0, tax: 0 };
                testAppState.rows.forEach(row => {
                    const name = IFTA_TAX_RATES.jurisdictions[row.jurisdiction]?.name || row.jurisdiction;
                    csv += `"${name} (${row.jurisdiction})",${row.totalMiles},${row.taxableMiles},${row.taxPaidGallons},${row.taxRate.toFixed(4)},${row.taxableGallons.toFixed(3)},${row.netTaxableGallons.toFixed(3)},${row.taxDue.toFixed(2)}\n`;
                    totals.miles += row.totalMiles;
                    totals.tax += row.taxDue;
                });
                csv += `\nTOTAL,${totals.miles},,,,,,${totals.tax.toFixed(2)}\n`;
                csv += `\n"Tax Status:","${totals.tax >= 0 ? 'Tax Due' : 'Credit/Refund'}",,,,,,${totals.tax >= 0 ? '' : '-'}$${Math.abs(totals.tax).toFixed(2)}\n`;
                
                downloadFile(csv, 'ifta-test-report.xlsx', 'application/vnd.ms-excel');
                results.excel = true;
                showStatus('excelStatus', '‚úì Excel file downloaded', 'success');
            } catch (error) {
                results.excel = false;
                showStatus('excelStatus', '‚úï Error: ' + error.message, 'error');
            }
        }
        
        function testPrint() {
            showStatus('printStatus', '‚Ñπ Print dialog would open on main app page', 'info');
            results.print = true;
        }
        
        function testSave() {
            try {
                // Test localStorage availability
                const test = '__storage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                
                const data = {
                    version: '1.1.0',
                    ...testAppState,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('iftaWizardTestData', JSON.stringify(data));
                results.save = true;
                showStatus('saveStatus', `‚úì Saved ${testAppState.rows.length} trips to localStorage`, 'success');
            } catch (error) {
                results.save = false;
                showStatus('saveStatus', '‚úï Error: ' + error.message, 'error');
            }
        }
        
        function testLoad() {
            try {
                const savedData = localStorage.getItem('iftaWizardTestData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    if (data && data.rows && Array.isArray(data.rows)) {
                        results.load = true;
                        const savedDate = new Date(data.savedAt);
                        showStatus('loadStatus', `‚úì Loaded ${data.rows.length} trips from ${savedDate.toLocaleString()}`, 'success');
                    } else {
                        throw new Error('Invalid data structure');
                    }
                } else {
                    results.load = true;
                    showStatus('loadStatus', '‚Ñπ No saved data found (run save test first)', 'info');
                }
            } catch (error) {
                results.load = false;
                showStatus('loadStatus', '‚úï Error: ' + error.message, 'error');
            }
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function clearTestData() {
            try {
                localStorage.removeItem('iftaWizardTestData');
                localStorage.removeItem('iftaWizardData');
                localStorage.removeItem('iftaRatesCache');
                alert('Test data cleared successfully!');
            } catch (e) {
                alert('Error clearing data: ' + e.message);
            }
        }
        
        function runAllTests() {
            // Reset results
            Object.keys(results).forEach(k => delete results[k]);
            
            testPdfExport();
            setTimeout(() => testCsvExport(), 500);
            setTimeout(() => testExcelExport(), 1000);
            setTimeout(() => testPrint(), 1500);
            setTimeout(() => testSave(), 2000);
            setTimeout(() => testLoad(), 2500);
            
            setTimeout(() => {
                const resultsDiv = document.getElementById('results');
                const content = document.getElementById('resultsContent');
                
                const tests = [
                    { name: 'PDF Export', key: 'pdf' },
                    { name: 'CSV Export', key: 'csv' },
                    { name: 'Excel Export', key: 'excel' },
                    { name: 'Print Report', key: 'print' },
                    { name: 'Save Session', key: 'save' },
                    { name: 'Load Session', key: 'load' }
                ];
                
                let html = '';
                let passed = 0;
                
                tests.forEach(test => {
                    const pass = results[test.key];
                    if (pass) passed++;
                    html += `
                        <div class="result-item">
                            <span>${test.name}</span>
                            <span class="${pass ? 'result-pass' : 'result-fail'}">${pass ? '‚úì PASS' : '‚úï FAIL'}</span>
                        </div>
                    `;
                });
                
                html += `
                    <div class="result-item" style="margin-top: 10px; padding-top: 10px; border-top: 2px solid rgba(255,255,255,0.2);">
                        <span><strong>Total</strong></span>
                        <span class="${passed === tests.length ? 'result-pass' : 'result-fail'}">
                            <strong>${passed}/${tests.length} Tests Passed</strong>
                        </span>
                    </div>
                `;
                
                content.innerHTML = html;
                resultsDiv.style.display = 'block';
            }, 3000);
        }
        
        function openMainApp() {
            window.open('/', '_blank');
        }
    </script>
</body>
</html>
