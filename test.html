<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IFTA Wizard - Test Suite</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
        h1 { color: #2563eb; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .test-section h2 { margin-top: 0; color: #333; }
        .test { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .test.pass { background: #d4edda; border-left: 4px solid #28a745; }
        .test.fail { background: #f8d7da; border-left: 4px solid #dc3545; }
        .test.info { background: #e7f3ff; border-left: 4px solid #0066cc; }
        .result { font-weight: bold; }
        .details { font-size: 0.9em; color: #666; margin-top: 5px; }
        .summary { font-size: 1.2em; padding: 20px; margin-top: 20px; border-radius: 8px; }
        .summary.all-pass { background: #d4edda; }
        .summary.has-fail { background: #f8d7da; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f0f0f0; }
        .number { text-align: right; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üß™ IFTA Wizard Test Suite</h1>
    <p>Testing all functionality of the IFTA Wizard application.</p>
    
    <div id="testResults"></div>
    
    <script src="tax-rates.js"></script>
    <script src="rate-fetcher.js"></script>
    <script>
        const results = [];
        let passCount = 0;
        let failCount = 0;
        
        function test(name, fn) {
            try {
                const result = fn();
                if (result.pass) {
                    passCount++;
                    results.push({ name, pass: true, message: result.message, details: result.details });
                } else {
                    failCount++;
                    results.push({ name, pass: false, message: result.message, details: result.details });
                }
            } catch (error) {
                failCount++;
                results.push({ name, pass: false, message: `Error: ${error.message}`, details: error.stack });
            }
        }
        
        function info(name, message, details) {
            results.push({ name, info: true, message, details });
        }
        
        // ============ TAX RATES DATA TESTS ============
        
        test('Tax rates data loaded', () => {
            const loaded = typeof IFTA_TAX_RATES !== 'undefined';
            return { 
                pass: loaded, 
                message: loaded ? 'IFTA_TAX_RATES object loaded' : 'IFTA_TAX_RATES not found',
                details: loaded ? `Quarter: ${IFTA_TAX_RATES.quarter}, Jurisdictions: ${Object.keys(IFTA_TAX_RATES.jurisdictions).length}` : null
            };
        });
        
        test('All 48 US states present', () => {
            const usStates = ['AL','AZ','AR','CA','CO','CT','DE','FL','GA','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
            const missing = usStates.filter(s => !IFTA_TAX_RATES.jurisdictions[s]);
            return {
                pass: missing.length === 0,
                message: missing.length === 0 ? 'All 48 US states found' : `Missing states: ${missing.join(', ')}`,
                details: `Checked ${usStates.length} states`
            };
        });
        
        test('All 10 Canadian provinces present', () => {
            const provinces = ['AB','BC','MB','NB','NL','NS','ON','PE','QC','SK'];
            const missing = provinces.filter(p => !IFTA_TAX_RATES.jurisdictions[p]);
            return {
                pass: missing.length === 0,
                message: missing.length === 0 ? 'All 10 Canadian provinces found' : `Missing: ${missing.join(', ')}`,
                details: `Checked ${provinces.length} provinces`
            };
        });
        
        test('getTaxRate function works', () => {
            const txDiesel = getTaxRate('TX', 'diesel');
            const caDiesel = getTaxRate('CA', 'diesel');
            return {
                pass: txDiesel > 0 && caDiesel > 0,
                message: `TX diesel: $${txDiesel.toFixed(4)}, CA diesel: $${caDiesel.toFixed(4)}`,
                details: 'getTaxRate() returns valid rates'
            };
        });
        
        // ============ MATH CALCULATION TESTS ============
        
        test('Taxable gallons calculation', () => {
            // Formula: Taxable Gallons = Taxable Miles / Fleet MPG
            const taxableMiles = 1000;
            const fleetMpg = 6.5;
            const expected = taxableMiles / fleetMpg; // 153.846...
            const calculated = 1000 / 6.5;
            const pass = Math.abs(calculated - expected) < 0.001;
            return {
                pass,
                message: `1000 miles √∑ 6.5 MPG = ${calculated.toFixed(3)} gallons`,
                details: `Expected: ${expected.toFixed(6)}, Got: ${calculated.toFixed(6)}`
            };
        });
        
        test('Net taxable gallons calculation', () => {
            // Formula: Net Taxable = Taxable Gallons - Tax Paid Gallons
            const taxableGallons = 153.846;
            const taxPaidGallons = 100;
            const expected = taxableGallons - taxPaidGallons; // 53.846
            const calculated = 153.846 - 100;
            return {
                pass: Math.abs(calculated - expected) < 0.001,
                message: `153.846 taxable - 100 paid = ${calculated.toFixed(3)} net taxable`,
                details: `Positive = tax owed, Negative = credit`
            };
        });
        
        test('Tax due calculation', () => {
            // Formula: Tax Due = Net Taxable Gallons √ó Tax Rate
            const netTaxable = 53.846;
            const taxRate = 0.20; // TX diesel rate
            const expected = netTaxable * taxRate; // 10.7692
            const calculated = 53.846 * 0.20;
            return {
                pass: Math.abs(calculated - expected) < 0.01,
                message: `53.846 gal √ó $0.20 = $${calculated.toFixed(2)} tax due`,
                details: `Expected: $${expected.toFixed(4)}`
            };
        });
        
        test('Tax credit calculation (negative)', () => {
            // When you buy more fuel than consumed = credit
            const taxableMiles = 500;
            const fleetMpg = 6.5;
            const taxPaidGallons = 100; // Bought 100 gal but only used 76.92
            const taxableGallons = taxableMiles / fleetMpg; // 76.923
            const netTaxable = taxableGallons - taxPaidGallons; // -23.077
            const taxRate = 0.20;
            const taxDue = netTaxable * taxRate; // -4.615 (credit)
            return {
                pass: taxDue < 0,
                message: `500 miles uses ${taxableGallons.toFixed(3)} gal, bought 100 = $${taxDue.toFixed(2)} credit`,
                details: 'Negative tax = credit/refund'
            };
        });
        
        // ============ COMPLETE SCENARIO TEST ============
        
        info('Complete IFTA Calculation Scenario', 'Testing a real-world trucking scenario', null);
        
        test('Multi-jurisdiction scenario', () => {
            // Truck drives through TX, OK, KS, CO with fuel purchases
            const fleetMpg = 6.5;
            const trips = [
                { jurisdiction: 'TX', miles: 500, fuelPurchased: 80 },
                { jurisdiction: 'OK', miles: 300, fuelPurchased: 0 },
                { jurisdiction: 'KS', miles: 400, fuelPurchased: 100 },
                { jurisdiction: 'CO', miles: 200, fuelPurchased: 50 }
            ];
            
            let totalTax = 0;
            let details = '<table><tr><th>State</th><th>Miles</th><th>Taxable Gal</th><th>Purchased</th><th>Net Gal</th><th>Rate</th><th>Tax Due</th></tr>';
            
            trips.forEach(trip => {
                const rate = getTaxRate(trip.jurisdiction, 'diesel');
                const taxableGal = trip.miles / fleetMpg;
                const netGal = taxableGal - trip.fuelPurchased;
                const tax = netGal * rate;
                totalTax += tax;
                
                details += `<tr>
                    <td>${trip.jurisdiction}</td>
                    <td class="number">${trip.miles}</td>
                    <td class="number">${taxableGal.toFixed(3)}</td>
                    <td class="number">${trip.fuelPurchased.toFixed(3)}</td>
                    <td class="number">${netGal.toFixed(3)}</td>
                    <td class="number">$${rate.toFixed(4)}</td>
                    <td class="number">${tax >= 0 ? '' : '-'}$${Math.abs(tax).toFixed(2)}</td>
                </tr>`;
            });
            
            details += `<tr style="font-weight:bold;background:#f0f0f0;"><td>TOTAL</td><td class="number">1400</td><td></td><td class="number">230</td><td></td><td></td><td class="number">${totalTax >= 0 ? '' : '-'}$${Math.abs(totalTax).toFixed(2)}</td></tr></table>`;
            
            return {
                pass: true,
                message: `Total tax for 1400 miles through 4 states: ${totalTax >= 0 ? '$' : '-$'}${Math.abs(totalTax).toFixed(2)}`,
                details
            };
        });
        
        // ============ RATE FETCHER TESTS ============
        
        test('Rate fetcher loaded', () => {
            const loaded = typeof IFTARateFetcher !== 'undefined';
            return {
                pass: loaded,
                message: loaded ? 'IFTARateFetcher loaded' : 'IFTARateFetcher not found',
                details: loaded ? `Current quarter: ${IFTARateFetcher.getCurrentQuarter()}` : null
            };
        });
        
        test('Quarter detection', () => {
            const current = IFTARateFetcher.getCurrentQuarter();
            const next = IFTARateFetcher.getNextQuarter();
            const validFormat = /^\dQ\d{4}$/.test(current);
            return {
                pass: validFormat,
                message: `Current: ${current}, Next: ${next}`,
                details: 'Quarter format: [1-4]Q[YYYY]'
            };
        });
        
        // ============ DATA VALIDATION TESTS ============
        
        test('All diesel rates are reasonable', () => {
            const jurisdictions = Object.entries(IFTA_TAX_RATES.jurisdictions);
            const badRates = jurisdictions.filter(([code, data]) => {
                const rate = data.rates.diesel;
                return rate < 0 || rate > 1.50; // Rates should be between $0 and $1.50
            });
            return {
                pass: badRates.length === 0,
                message: badRates.length === 0 ? 'All diesel rates within expected range' : `${badRates.length} rates out of range`,
                details: badRates.length > 0 ? badRates.map(([c,d]) => `${c}: $${d.rates.diesel}`).join(', ') : 'All rates between $0.00 and $1.50'
            };
        });
        
        test('Exchange rates are valid', () => {
            const usToCAD = IFTA_TAX_RATES.exchangeRate.usToCanada;
            const cadToUS = IFTA_TAX_RATES.exchangeRate.canadaToUs;
            const valid = usToCAD > 1 && usToCAD < 2 && cadToUS > 0.5 && cadToUS < 1;
            return {
                pass: valid,
                message: `US‚ÜíCAD: ${usToCAD}, CAD‚ÜíUS: ${cadToUS}`,
                details: valid ? 'Exchange rates are reasonable' : 'Exchange rates seem incorrect'
            };
        });
        
        // ============ SPECIFIC RATE VERIFICATION ============
        
        info('Rate Verification', 'Checking specific known rates against Q4 2025 data', null);
        
        test('California diesel rate (highest)', () => {
            const rate = getTaxRate('CA', 'diesel');
            // CA has one of the highest diesel rates
            return {
                pass: rate > 0.90,
                message: `CA diesel: $${rate.toFixed(4)}/gallon`,
                details: 'California typically has highest diesel rates'
            };
        });
        
        test('Texas diesel rate', () => {
            const rate = getTaxRate('TX', 'diesel');
            return {
                pass: rate === 0.20,
                message: `TX diesel: $${rate.toFixed(4)}/gallon`,
                details: 'Texas rate should be $0.20'
            };
        });
        
        test('Pennsylvania diesel rate (high)', () => {
            const rate = getTaxRate('PA', 'diesel');
            return {
                pass: rate > 0.70,
                message: `PA diesel: $${rate.toFixed(4)}/gallon`,
                details: 'Pennsylvania has high fuel taxes'
            };
        });
        
        // ============ EDGE CASE TESTS ============
        
        info('Edge Case Testing', 'Testing boundary conditions and error handling', null);
        
        test('Invalid jurisdiction returns zero', () => {
            const rate = getTaxRate('ZZ', 'diesel');
            return {
                pass: rate === 0,
                message: `Invalid jurisdiction 'ZZ' returns: ${rate}`,
                details: 'Should safely return 0 for unknown jurisdictions'
            };
        });
        
        test('Invalid fuel type defaults correctly', () => {
            const rate = getTaxRate('TX', 'invalid_fuel');
            return {
                pass: rate === 0,
                message: `Unknown fuel type returns: ${rate}`,
                details: 'Should return 0 for unknown fuel types'
            };
        });
        
        test('Zero miles = zero tax', () => {
            const miles = 0;
            const mpg = 6.5;
            const fuelPurchased = 50;
            const taxableGal = miles / mpg;
            const netGal = taxableGal - fuelPurchased;
            const tax = netGal * 0.20;
            return {
                pass: tax === -10, // Credit of $10
                message: `0 miles with 50 gal purchased = $${tax.toFixed(2)} credit`,
                details: 'Zero miles means all fuel purchased is a credit'
            };
        });
        
        test('Very high MPG reduces liability', () => {
            const miles = 1000;
            const mpg = 15; // Very efficient
            const fuelPurchased = 100;
            const taxableGal = miles / mpg; // 66.67
            const netGal = taxableGal - fuelPurchased; // -33.33
            const tax = netGal * 0.20; // -6.67 credit
            return {
                pass: tax < 0,
                message: `High MPG (15): $${tax.toFixed(2)} credit`,
                details: 'Efficient vehicles get more credits'
            };
        });
        
        test('Division by very small MPG is handled', () => {
            // Should not divide by zero or very small numbers
            const miles = 1000;
            const mpg = 0.1; // Very small (edge case)
            const taxableGal = miles / mpg; // 10000 gallons
            return {
                pass: taxableGal === 10000 && isFinite(taxableGal),
                message: `1000 miles / 0.1 MPG = ${taxableGal.toFixed(0)} gallons`,
                details: 'Very low MPG handled correctly (though unrealistic)'
            };
        });
        
        test('Large numbers handled correctly', () => {
            const miles = 500000; // Half million miles
            const mpg = 6.5;
            const taxableGal = miles / mpg;
            const tax = taxableGal * 0.20;
            return {
                pass: isFinite(tax) && tax > 0,
                message: `500K miles = $${tax.toLocaleString(undefined, {minimumFractionDigits: 2})} tax`,
                details: 'Large mileage calculations work correctly'
            };
        });
        
        // ============ EXPORT FORMAT TESTS ============
        
        test('CSV export format', () => {
            // Simulate CSV generation
            const rows = [
                { jurisdiction: 'TX', totalMiles: 500, taxableMiles: 500, taxPaidGallons: 80, taxRate: 0.20, taxableGallons: 76.923, netTaxableGallons: -3.077, taxDue: -0.62 }
            ];
            
            let csv = 'Jurisdiction,Total Miles,Taxable Miles,Tax Paid Gallons,Tax Rate,Taxable Gallons,Net Taxable Gallons,Tax Due\n';
            rows.forEach(row => {
                csv += `${row.jurisdiction},${row.totalMiles},${row.taxableMiles},${row.taxPaidGallons},${row.taxRate},${row.taxableGallons.toFixed(3)},${row.netTaxableGallons.toFixed(3)},${row.taxDue.toFixed(2)}\n`;
            });
            
            const hasHeader = csv.includes('Jurisdiction');
            const hasData = csv.includes('TX');
            return {
                pass: hasHeader && hasData,
                message: 'CSV format is correct',
                details: `<pre>${csv}</pre>`
            };
        });
        
        // ============ MPG IMPACT TEST ============
        
        test('MPG impact on tax liability', () => {
            // Higher MPG = less fuel consumed = potentially more credit
            const miles = 1000;
            const fuelPurchased = 150;
            const taxRate = 0.20;
            
            const mpg6 = miles / 6.0; // 166.67 gal needed
            const mpg7 = miles / 7.0; // 142.86 gal needed
            
            const tax6 = (mpg6 - fuelPurchased) * taxRate; // (166.67 - 150) * 0.20 = $3.33 owed
            const tax7 = (mpg7 - fuelPurchased) * taxRate; // (142.86 - 150) * 0.20 = -$1.43 credit
            
            return {
                pass: tax6 > 0 && tax7 < 0,
                message: `6 MPG: $${tax6.toFixed(2)} owed, 7 MPG: $${Math.abs(tax7).toFixed(2)} credit`,
                details: 'Better fuel efficiency reduces tax liability'
            };
        });
        
        // ============ RENDER RESULTS ============
        
        function renderResults() {
            const container = document.getElementById('testResults');
            let html = '';
            
            let currentSection = '';
            results.forEach(r => {
                if (r.info) {
                    html += `<div class="test-section"><h2>${r.name}</h2>`;
                    if (r.message) html += `<p>${r.message}</p>`;
                    if (r.details) html += r.details;
                    html += '</div>';
                } else {
                    html += `<div class="test ${r.pass ? 'pass' : 'fail'}">`;
                    html += `<span class="result">${r.pass ? '‚úÖ PASS' : '‚ùå FAIL'}</span> - <strong>${r.name}</strong>`;
                    html += `<div>${r.message}</div>`;
                    if (r.details) html += `<div class="details">${r.details}</div>`;
                    html += '</div>';
                }
            });
            
            html += `<div class="summary ${failCount === 0 ? 'all-pass' : 'has-fail'}">`;
            html += `<strong>Test Summary:</strong> ${passCount} passed, ${failCount} failed`;
            html += `</div>`;
            
            container.innerHTML = html;
        }
        
        renderResults();
    </script>
</body>
</html>
